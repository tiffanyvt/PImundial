<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARCup Experience</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="EscaneoAR.css">
</head>

<body>
    <div class="app">
        <header>
            <div class="brand">
                <span class="dot" aria-hidden="true"></span>
                <div>ARCup Experience</div>
            </div>
        </header>

        <main>
            <section class="stage">
                <div class="topbar">
                    <div class="badge" role="status" aria-live="polite">
                    <span class="dot"></span>
                    <span class="hint" id="scanHint"><b>Escanea una bandera y selecciona uno de los 4 botones</b></span>
                    </div>
                    <button class="ui" id="btnAyuda" aria-haspopup="dialog" aria-controls="panelInfo">¬øC√≥mo funciona?</button>
                </div>

                <!-- AYUDA R√ÅPIDA -->
                <div class="panel" id="panelInfo" role="dialog" aria-modal="false" aria-labelledby="helpTitle">
                    <button class="close" id="closeInfo">Cerrar</button>
                    <h3 id="helpTitle">Ayuda r√°pida</h3>
                    <ol>
                        <li>Apunta la bandera de los pa√≠ses clasificados a la c√°mara.</li>
                        <li>Usa los botones para: ver video, estad√≠sticas, un modelo 3D animado o una trivia.</li>
                    </ol>
                    <p>Para una explicaci√≥n m√°s detallada:</p>
                        <a href="ManualDeUsuario.pdf" target="_blank">
                            <button class="ui-manual">Ver manual de usuario</button>
                    </a>
                </div>

                <!-- PANEL ESTAD√çSTICAS -->
                <div class="panel" id="panelStats" style="display:none;">
                <h3>Estad√≠sticas</h3>
                <ul id="statsContent"></ul>
                </div>

                <!-- PANEL TRIVIA -->
                <div class="panel" id="panelTrivia" style="display:none;">
                <h3>Trivia</h3>
                <div id="triviaContent"></div>
                </div>

                <!-- HISTOGRAMA -->
                <aside id="histPanel" class="hist-panel">
                <div class="hist-header">
                    <h4>Histograma RGB</h4>
                    <button id="histToggle" aria-pressed="false">‚ñ§</button>
                </div>
                <canvas id="histCanvas" width="256" height="100"></canvas>
                </aside>

                <!-- BOTONES PRINCIPALES -->
                <div class="overlay-menu" id="overlay-menu" aria-label="Controles" style="display: none;">
                    <button class="ui" id="btnVideo">1. Ver video</button>
                    <button class="ui" id="btnStats">2. Estad√≠sticas</button>
                    <button class="ui" id="btnModelo">3. Modelo 3D</button>
                    <button class="ui" id="btnTrivia">4. Trivia</button>
                </div>

                <!-- MIND-AR -->
                <a-scene
                    mindar-image="imageTargetSrc: ./assets/banderas.mind; autoStart: true;"
                    renderer="colorManagement: true; physicallyCorrectLights: false"
                    color-space:="sRGB"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: true"
                >

                    <a-assets>
                        <!-- Modelos -->
                        <a-asset-item id="modeloFlag" src="./modelos/mexico_flag/mexico_flag.gltf"></a-asset-item>

                        <!-- Videos -->
                        <video id="videoMX" src="./assets/videoMX.mp4" loop crossorigin="anonymous" webkit-playsinline playsinline muted></video>
                    </a-assets>

                    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

                    <!-- TARGETS = BANDERAS -->

                    <!--== TARGET: M√©xico (1) ==-->
                    <a-entity mindar-image-target="targetIndex: 0" id="targetMX">
                        <a-gltf-model 
                            id="gltfMX" src="#modeloFlag"
                            position="0 -0.20 0.1" scale="0.0002 0.0002 0.0002" visible="false"
                            animation-mixer="clip: *; loop: repeat">
                        </a-gltf-model>

                        <a-video id="videoMexico" src="#videoMX" 
                        width="0.4" height="0.7" position="0 0 0" visible="false"></a-video>

                        <a-entity id="statsGroup" visible="false">
                            <a-plane id="statsBG" position="0 0 0" 
                                     width="0.5" height="0.5" 
                                     color="#0f1a3a" opacity="0.7"
                                     material="shader: standard; side: double; rounded:true;">
                            </a-plane>
                            <a-text id="statsText" value=""></a-text>
                        </a-entity>
                    </a-entity>
                </a-scene>
            </section>
        </main>
    </div>
    
    <!-- JAVASCRIPT -->
    <script>
        const overlayMenu = document.getElementById("overlay-menu");
        const scanHint = document.getElementById("scanHint");
        const btnModelo = document.getElementById("btnModelo");
        const btnVideo = document.getElementById("btnVideo");
        const btnTrivia = document.getElementById("btnTrivia");
        const btnStats = document.getElementById("btnStats");
        
        // Bot√≥n ayuda
        const btnAyuda = document.getElementById('btnAyuda');
        const panelInfo = document.getElementById('panelInfo');
        const closeInfo = document.getElementById('closeInfo');
        btnAyuda.addEventListener('click', ()=> panelInfo.style.display = 'block');
        closeInfo.addEventListener('click', ()=> panelInfo.style.display = 'none');

        const gltfMexico = document.getElementById("gltfMX");

        let DATA = {};
        let currentTarget = null;

        fetch("datos.json")
        .then((res) => res.json())
        .then((json) => {
            DATA = json;
            console.log("Datos mostrados:", DATA);
        })
        .catch((err) => console.error("Hubo un error cargando datos.json:", err));

        // TARGETS
        const targetMexico = document.getElementById("targetMX");

        // 1. M√âXICO
        targetMexico.addEventListener("targetFound", () => {
            console.log("Pais detectado: M√©xico");
            currentTarget = "mexico";
            overlayMenu.style.display = "block"; 
        });
        targetMexico.addEventListener("targetLost", () => {
            console.log("No se detecta M√©xico");
            currentTarget = null;
            overlayMenu.style.display = "none";

            ocultarTodo();

            // Video
            const videoCont = document.getElementById("videoMX");
            const videoAR = document.getElementById("videoMexico");

            if (videoCont) {
                videoCont.pause();
                videoCont.currentTime = 0; 
            }
            if (videoAR) {
                videoAR.setAttribute("visible", "false");
            }
        });

        // Bot√≥n Modelo 3D
        btnModelo.addEventListener("click", () => {
            console.log("Clic en bot√≥n modelo 3D, target:", currentTarget);
            if (!currentTarget) return;
            ocultarTodo();
            const model = document.getElementById("gltfMX");
            const videoAR = document.getElementById("videoMexico");
            const videoEl = document.getElementById("videoMX");
            if (model) model.setAttribute("visible", "true");
            if (videoAR) videoAR.setAttribute("visible", "false");
            if (videoEl) { videoEl.pause(); 
                videoEl.muted = true;
            }
            const vc = document.getElementById("videoControls");
            if (vc) vc.style.display = "none";

            if( currentTarget === "mexico") {
                gltfMexico.setAttribute("visible","true");
                gltfMexico.setAttribute("animation", "property: rotation; to: 0 360 0; loop:true; dur:10000");
            }
        });

       // Bot√≥n Ver Video
        btnVideo.addEventListener("click", () => {
            if(!currentTarget) return;
            ocultarTodo();

            let videoCont = null;
            let videoAR = null;
            let model = null;

            if (currentTarget === "mexico") {
                videoCont = document.getElementById("videoMX"); //<video>
                videoAR = document.getElementById("videoMexico"); //<a-video>
                model = document.getElementById("gltfMX"); 
            }

            if (videoCont && videoAR) {
                if (model) {
                    model.setAttribute("visible", "false");
                    model.removeAttribute("animation"); 
                }

                videoAR.setAttribute("visible", "true");
                videoCont.muted = false;
                videoCont.playsInline = true;

                videoCont.pause();
                videoCont.currentTime = 0;

                videoCont.oncanplay = () => {
                    videoCont.play().catch(err => console.log("Hubo un error al reproducir el video:", err));
                    videoCont.oncanplay = null;
                };

                videoAR.setAttribute("src", "#" + videoCont.id);
            }
        });

        // Paneles
        const panelStats = document.getElementById("panelStats");
        const statsContent = document.getElementById("statsContent");
        const statsGroup = document.getElementById("statsGroup");

        const panelTrivia = document.getElementById("panelTrivia");
        const triviaContent = document.getElementById("triviaContent");

        // Bot√≥n Estad√≠sticas
        function mostrarStatsAR(pais) {
            const statsText = document.getElementById("statsText");
            if (pais && pais.stats) {
                statsText.setAttribute("value", 
                    `${pais.pais}\n` + 
                    `Partidos disputados: ${pais.stats.partidos}\n` +
                    `Victorias obtenidas: ${pais.stats.victorias}\n` +
                    `Derrotas: ${pais.stats.derrotas}\n` +
                    `Empates: ${pais.stats.empates}\n` +
                    `Goles marcados: ${pais.stats.goles}`
                );
                statsText.setAttribute("color", "#FFD700");
                statsText.setAttribute("width", 1);
                statsText.setAttribute("align", "center");
                statsText.setAttribute("position", "0 0 0.02");
                statsText.setAttribute("font", "https://cdn.aframe.io/fonts/Roboto-msdf.json"); 
                statsGroup.setAttribute("visible", "true");
                statsText.setAttribute("wrap-count", 40);
            }
        }

        btnStats.addEventListener("click", () => {
            if (!currentTarget) return;
            ocultarTodo(); 

           const pais = DATA[currentTarget];
           mostrarStatsAR(pais);
        });

        // Bot√≥n Trivia
        btnTrivia.addEventListener("click", () => {
            if (!currentTarget) return;
            ocultarTodo(); 

            const pais = DATA[currentTarget];
            if (pais && pais.trivia) {
                triviaContent.innerHTML = "";
                pais.trivia.forEach((q, idx) => {                
                const div = document.createElement("div");
                div.classList.add("trivia-question");
                div.innerHTML = `
                    <p><b>${q.pregunta}</b></p>
                    <div class="options">
                    ${q.opciones.map(opt => `<button class="trivia-opt">${opt}</button>`).join(" ")}
                    </div>
                    <div class="feedback"></div>
                    <hr>
                `;
                triviaContent.appendChild(div);

                 // Respuestas
                div.querySelectorAll(".trivia-opt").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const feedback = div.querySelector(".feedback");
                    if (btn.textContent === q.respuesta) {
                        feedback.textContent = "Correcto üíØ";
                        feedback.style.color = "#3ef11e";
                    } else {
                        feedback.textContent = `Incorrecto. La respuesta es: ${q.respuesta}`;
                        feedback.style.color = "#d00000";
                    }
                    });
                });
                });
            } else {
                triviaContent.innerHTML = "<p>No hay pregunta disponible</p>";
            }

            panelTrivia.style.display = "block";
        });

        function ocultarTodo() {
            // MODELO
            gltfMexico.setAttribute("visible", "false");
            gltfMexico.removeAttribute("animation");

            // VIDEO
            const videoCont = document.getElementById("videoMX");
            const videoAR = document.getElementById("videoMexico");
            if (videoCont) {
                videoCont.pause();
                videoCont.muted = true;
            }
            if (videoAR) videoAR.setAttribute("visible", "false");

            // ESTADISTICAS  
            statsGroup.setAttribute("visible", "false");

            panelStats.style.display = "none";
            panelTrivia.style.display = "none";
        }

        /*// HISTOGRAMA
        (function(){
            const histPanel = document.getElementById('histPanel');
            const histToggle = document.getElementById('histToggle');
            const canvas = document.getElementById('histCanvas');
            const ctx = canvas.getContext('2d');
            const tmpCanvas = document.createElement('canvas');
            const tmpCtx = tmpCanvas.getContext('2d');

            let rafId = null;

            function getSourceVideo() {
                const vids = Array.from(document.querySelectorAll('video'));
                const preferMX = vids.find(v=> v.id === 'videoMX' && !v.paused && v.readyState >= 2);
                if (preferMX) return preferMX;
                return vids.find(v => !v.paused && v.readyState >= 2) || null;
            }

            function sampleFrame(){
                const src = getSourceVideo();
                if (!src) { rafId = requestAnimationFrame(sampleFrame); return; }

                const w = 160, h = 90;
                tmpCanvas.width = w; tmpCanvas.height = h;
                tmpCtx.drawImage(src,0,0,w,h);
                let data;
                try {
                data = tmpCtx.getImageData(0,0,w,h).data;
                } catch(e) {
                console.warn('CORS issue con video:', e);
                cancelAnimationFrame(rafId);
                return;
                }

                // bins de 256 intensidades
                const binsR = new Array(256).fill(0);
                const binsG = new Array(256).fill(0);
                const binsB = new Array(256).fill(0);

                for(let i=0; i<data.length; i+=4){
                binsR[data[i]]++;
                binsG[data[i+1]]++;
                binsB[data[i+2]]++;
                }

                const maxVal = Math.max(
                Math.max(...binsR),
                Math.max(...binsG),
                Math.max(...binsB)
                );

                ctx.clearRect(0,0,canvas.width,canvas.height);

                function drawHist(bins, color){
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.globalAlpha = 0.6;
                for(let x=0; x<256; x++){
                    const val = bins[x] / maxVal * canvas.height;
                    ctx.moveTo(x, canvas.height);
                    ctx.lineTo(x, canvas.height - val);
                }
                ctx.stroke();
                ctx.globalAlpha = 1;
                }

                drawHist(binsR, "red");
                drawHist(binsG, "lime");
                drawHist(binsB, "blue");

                rafId = requestAnimationFrame(sampleFrame);
            }

            function start() {
                if (!rafId) rafId = requestAnimationFrame(sampleFrame);
            }
            function stop() {
                if (rafId) cancelAnimationFrame(rafId);
                rafId = null;
            }

            // play/pause listener
            document.addEventListener('play', e => {
                if (e.target.tagName==="VIDEO") start();
            }, true);
            document.addEventListener('pause', e => {
                const anyPlaying = Array.from(document.querySelectorAll('video')).some(v=>!v.paused && v.readyState>=2);
                if (!anyPlaying) stop();
            }, true);

            histToggle.addEventListener('click', ()=>{
                histPanel.classList.toggle('minimized');
            });

            })();*/
        </script>
        
</body>
</html>