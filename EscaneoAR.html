<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARCup Experience</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="EscaneoAR.css">
</head>

<body>
    <div class="app">
        <header>
            <div class="brand">
                <span class="dot" aria-hidden="true"></span>
                <div>ARCup Experience</div>
            </div>
        </header>

        <main>
            <section class="stage">
                <div class="topbar">
                    <div class="badge" role="status" aria-live="polite">
                    <span class="dot"></span>
                    <span class="hint" id="scanHint"><b>Escanea una bandera y selecciona uno de los 4 botones</b></span>
                    </div>
                    <button class="ui" id="btnAyuda" aria-haspopup="dialog" aria-controls="panelInfo">¿Cómo funciona?</button>
                </div>

                <!-- AYUDA RÁPIDA -->
                <div class="panel" id="panelInfo" role="dialog" aria-modal="false" aria-labelledby="helpTitle">
                    <button class="close" id="closeInfo">Cerrar</button>
                    <h3 id="helpTitle">Ayuda rápida</h3>
                    <ol>
                        <li>Apunta la bandera de los países clasificados a la cámara.</li>
                        <li>Usa los botones para: ver video, estadísticas, un modelo 3D animado o una trivia.</li>
                    </ol>
                    <p>Para una explicación más detallada:</p>
                        <a href="ManualDeUsuario.pdf" target="_blank">
                            <button class="ui-manual">Ver manual de usuario</button>
                    </a>
                </div>

                <!-- BOTONES -->
                <div class="overlay-menu" id="overlay-menu" aria-label="Controles" style="display: none;">
                    <button class="ui" id="btnVideo">1. Ver video</button>
                    <button class="ui" id="btnStats">2. Estadísticas</button>
                    <button class="ui" id="btnModelo">3. Modelo 3D</button>
                    <button class="ui" id="btnTrivia">4. Trivia</button>
                </div>

                <!-- MIND-AR -->
                <a-scene
                    mindar-image="imageTargetSrc: ./assets/banderas.mind; autoStart: true;"
                    renderer="colorManagement: true; physicallyCorrectLights: false"
                    color-space:="sRGB"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: true"
                >

                    <a-assets>
                        <!-- Modelos -->
                        <a-asset-item id="modeloTrofeo" src="./modelos/trofeo/trofeoo.gltf"></a-asset-item>

                        <!-- Videos -->
                        <video id="videoMX" src="./assets/videoMX.mp4" loop crossorigin="anonymous" webkit-playsinline playsinline muted></video>
                    </a-assets>

                    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

                    <!-- TARGETS = BANDERAS -->

                    <!--== TARGET: México (1) ==-->
                    <a-entity mindar-image-target="targetIndex: 0" id="targetMX">
                        <a-gltf-model id="gltfMX" src="#modeloTrofeo"
                        position="0 -0.20 0.1" scale="0.8 0.8 0.8" visible="false">
                        </a-gltf-model>

                        <a-video id="videoMexico" src="#videoMX" 
                        width="0.5" height="1" position="0 0 0" visible="false"></a-video>
                    </a-entity>

                </a-scene>
            </section>
        </main>
    </div>
    
    <!-- JAVASCRIPT -->
    <script>
        const overlayMenu = document.getElementById("overlay-menu");
        const scanHint = document.getElementById("scanHint");
        const btnModelo = document.getElementById("btnModelo");
        const btnVideo = document.getElementById("btnVideo");
        const btnTrivia = document.getElementById("btnTrivia");
        const btnStats = document.getElementById("btnStats");
        
        // Botón ayuda
        const btnAyuda = document.getElementById('btnAyuda');
        const panelInfo = document.getElementById('panelInfo');
        const closeInfo = document.getElementById('closeInfo');
        btnAyuda.addEventListener('click', ()=> panelInfo.style.display = 'block');
        closeInfo.addEventListener('click', ()=> panelInfo.style.display = 'none');

        const gltfMexico = document.getElementById("gltfMX");

        let DATA = {};
        let currentTarget = null;

        fetch("datos.json")
        .then((res) => res.json())
        .then((json) => {
            DATA = json;
            console.log("Datos mostrados:", DATA);
        })
        .catch((err) => console.error("Hubo un error cargando datos.json:", err));

        // TARGETS
        const targetMexico = document.getElementById("targetMX");

        // 1. MÉXICO
        targetMexico.addEventListener("targetFound", () => {
            console.log("Pais detectado: México");
            currentTarget = "mexico";
            overlayMenu.style.display = "block"; 
        });
        targetMexico.addEventListener("targetLost", () => {
            console.log("No se detecta México");
            currentTarget = null;
            overlayMenu.style.display = "none";
            gltfMexico.setAttribute("visible", "false");

            // Video
            const videoCont = document.getElementById("videoMX");
            const videoAR = document.getElementById("videoMexico");

            if (videoCont) {
                videoCont.pause();
                videoCont.currentTime = 0; 
            }
            if (videoAR) {
                videoAR.setAttribute("visible", "false");
            }
        });

        // Botón Modelo 3D
        btnModelo.addEventListener("click", () => {
            console.log("Clic en botón modelo 3D, target:", currentTarget);
            if (!currentTarget) return;
            if( currentTarget === "mexico") {
                gltfMexico.setAttribute("visible","true");
                gltfMexico.setAttribute("animation", "property: rotation; to: 0 360 0; loop:true; dur:10000");
            }
        });

        // Botón Ver Video
        btnVideo.addEventListener("click", () => {
            if(!currentTarget) return;

        let videoCont = null;
        let videoAR = null;

        if (currentTarget === "mexico") {
            videoCont = document.getElementById("videoMX"); //<video>
            videoAR = document.getElementById("videoMexico"); //<a-video>
        }

        if (videoCont && videoAR) {
            videoAR.setAttribute("visible", "true");

            videoCont.muted = false;
            videoCont.playsInline = true;

            videoCont.pause();
            videoCont.currentTime = 0;

            videoCont.oncanplay = () => {
                videoCont.play().catch(err => console.log("Hubo un error al reproducir el video:", err));
                videoCont.oncanplay = null;
            };

            videoAR.setAttribute("src", "#" + videoCont.id);
        }
        });
    </script>
</body>
</html>